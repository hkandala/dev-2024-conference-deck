import { CodeSurfer, CodeSurferColumns, Step } from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";
import { Notes } from "mdx-deck";

import "prismjs/components/prism-java";

import "./styles.css";

import diagram from "./assets/diagram.png";
import tweet from "./assets/tweet.png";
import comparisonVid from "./assets/comparison.mp4";
import comparisonImg from "./assets/comparison.png";
import channels from "./assets/channels.mp4";
import graph from "./assets/graph.png";

export const theme = {
  googleFont: "https://fonts.googleapis.com/css?family=IBM+Plex+Mono",
  fonts: {
    body: '"IBM Plex Mono", monospace',
    monospace: '"IBM Plex Mono", monospace',
  },
  colors: {
    text: "#f0eeed",
    background: "#161a1e",
  },
  styles: {
    root: {
      textAlign: "left",
    },
    Slide: {
      display: "block"
    },
    h1: {
      paddingBottom: "0.5em",
      borderBottom: "10px solid",
    },
    h2: {
      paddingBottom: "0.4em",
      borderBottom: "5px solid",
    },
    h3: {
      paddingBottom: "0.3em",
      borderBottom: "5px solid",
    },
    p: {
      fontSize: "0.75em",
    },
    li: {
      fontSize: "0.75em",
    },
  },
};

<div className="title-slide">

# Concurrency Models Demystified

Harish Kandala

</div>

---

<div className="content-slide">

### About Me

Harish Kandala

Enterprise Engineer @ Meta

TODO

</div>

---

<div className="image-slide">
  <Image className="image" src={tweet}></Image>
</div>

---

<div className="content-slide">

### Why Concurrency

- The clock speed, the metronome of processors, steadily increased until peaking at 3.7 GHz in 2004. Since then, it has dropped back to around 3 GHz.
- The number of transistors on a chip has continued to double every two years, but the power consumption has also doubled.
- The primary goal of using conccurent programming is to make the most of the available resources.

<br />

</div>

---

<div className="quote-slide">
<div>

> "The Free Lunch Is Over"

<div className="reference">- Herb Sutter</div>

</div>
</div>

---

<div className="image-slide" style={{ backgroundColor: "white" }}>
  <Image className="image" src={graph}></Image>
</div>

---

<div className="content-slide">

### What is Concurrency?

- The dictionary defines concurrency as... <br/> "simultaneous occurrence"
- Different names like thread, task, or process refer to simultaneous occurrences, all representing a sequence of instructions running in order.
- It involves breaking down tasks into smaller, independent units that can be executed out-of-order or in partial order, without affecting the final outcome.

<Notes>
  <div className="notes">lorem ipsum dolor sit amet</div>
</Notes>

</div>

---

<div className="content-slide">

### Concurrency vs Parallelism

As Rob Pike puts it:

- Concurrency is about dealing with lots of things at once.
- Parallelism is about doing lots of things at once.

</div>

---

<div className="center-slide">

<video width="1600" height="900" autoPlay loop>
  <source src={comparisonVid} type="video/mp4" />
  Your browser does not support the video tag.
</video>

</div>

---

<div className="image-slide" style={{ backgroundColor: "white" }}>
  <Image className="image" src={comparisonImg}></Image>
</div>

---

<div className="content-slide">

### What is Concurrency Model?

- A concurrency model is a way of structuring the code to make it easier to write and reason about concurrent programs.
- It is a way of thinking about concurrency.
- Concurrency models should be easy to use, understand, and reason about.

</div>

---

<div className="content-slide">

### Shared Mutable State

- Shared mutable state is the root of all evil in concurrent programming.
- It is the cause of most concurrency bugs and performance issues.

</div>

---

<div className="image-slide">
  <Image className="image" src={diagram}></Image>
</div>

---

<CodeSurfer theme={vsDark}>

```java
public class Account {
  private int id;
  private int balance;

  public Account(int id, int balance) {
    this.id = id;
    this.balance = balance;
  }

  public void deposit(int amount) {
    balance += amount;
  }

  public void withdraw(int amount) {
    if (balance >= amount) {
      balance -= amount;
    }
  }

  public int getAccountID() {
    return id;
  }

  public int getBalance() {
    return balance;
  }
}
```

```diff 10:12

```

```diff 14:18

```

</CodeSurfer>

---

<CodeSurfer theme={vsDark}>

```java
public class Main {
  public static void main(String[] args) throws InterruptedException {
    final Account[] accounts = new Account[5];
    for (int i = 0; i < accounts.length; i++) {
      accounts[i] = new Account(i, 100);
    }

    ExecutorService executor = Executors.newFixedThreadPool(20);
    for (int i = 0; i < 1000; i++) {
      final int idx = (int) (Math.random() * 5);
      final int amount = (int) (Math.random() * 91) + 10;
      if (Math.random() > 0.5) {
        executor.execute(() -> {
          accounts[idx].deposit(amount);
        });
      } else {
        executor.execute(() -> {
          accounts[idx].withdraw(amount);
        });
      }
    }

    shutdownAndAwaitTermination(executor);

    System.out.println("\nFinal balances:");
    for (int i = 0; i < accounts.length; i++) {
      System.out.println("Account " + i + ": " + accounts[i].getBalance());
    }
  }
}
```

```diff 3:6

```

```diff 8:21

```

</CodeSurfer>

---

<CodeSurfer theme={vsDark}>

```java
public class Account {
  private int id;
  private int balance;

  public Account(int id, int balance) {
    this.id = id;
    this.balance = balance;
  }

  public void deposit(int amount) {
    balance += amount;
  }

  public void withdraw(int amount) {
    if (balance >= amount) {
      balance -= amount;
    }
  }

  public int getAccountID() {
    return id;
  }

  public int getBalance() {
    return balance;
  }
}
```

```java
public class Account {
  private int id;
  private int balance;

  private final Lock lock = new ReentrantLock();

  public Account(int id, int balance) {
    this.id = id;
    this.balance = balance;
  }

  public void deposit(int amount) {
    balance += amount;
  }

  public void withdraw(int amount) {
    if (balance >= amount) {
      balance -= amount;
    }
  }

  public int getAccountID() {
    return id;
  }

  public int getBalance() {
    return balance;
  }
}
```

```java 12:19
public class Account {
  private int id;
  private int balance;

  private final Lock lock = new ReentrantLock();

  public Account(int id, int balance) {
    this.id = id;
    this.balance = balance;
  }

  public void deposit(int amount) {
    lock.lock();
    try {
      balance += amount;
    } finally {
      lock.unlock();
    }
  }

  public void withdraw(int amount) {
    if (balance >= amount) {
      balance -= amount;
    }
  }

  public int getAccountID() {
    return id;
  }

  public int getBalance() {
    return balance;
  }
}
```

```java 21:30
public class Account {
  private int id;
  private int balance;

  private final Lock lock = new ReentrantLock();

  public Account(int id, int balance) {
    this.id = id;
    this.balance = balance;
  }

  public void deposit(int amount) {
    lock.lock();
    try {
      balance += amount;
    } finally {
      lock.unlock();
    }
  }

  public void withdraw(int amount) {
    lock.lock();
    try {
      if (balance >= amount) {
        balance -= amount;
      }
    } finally {
      lock.unlock();
    }
  }

  public int getAccountID() {
    return id;
  }

  public int getBalance() {
    return balance;
  }
}
```

```diff

```

</CodeSurfer>

---

<div className="center-slide">

<video width="1600" height="900" autoPlay>
  <source src={channels} type="video/mp4" />
  Your browser does not support the video tag.
</video>

</div>

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js
const magna = (aliqua) => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);
```

</Step>

<Step>

```js
const lorem = (ipsum, dolor, sit) => {
  const amet = dolor - ipsum;
  return consectetur.adipiscing(
    {
      elit: sed.eiusmod(sit - dolor) / amet + 2,
    },
    (tempor, incididunt) => ipsum + amet * incididunt
  );
};

const magna = (aliqua) => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);

const sed = (eiusmod, tempor, incididunt) => {
  const ut = tempor - eiusmod;
  return labore.et(
    {
      amet: dolore.magna(incididunt - tempor) / ut + 2,
    },
    (aliqua, elit) => eiusmod + ut * elit
  );
};
```

</Step>

</CodeSurferColumns>

---

<div className="content-slide">

## References

</div>
